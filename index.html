<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ°æ”¿å£«æ¡ˆä»¶é€²åº¦ (Mac/Win/Mobile é€šç”¨çµ‚æ¥µç‰ˆ v12)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #f0f2f5; 
            font-family: "PingFang TC", "Microsoft JhengHei", -apple-system, sans-serif;
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        #app {
            background-color: #fff; width: 100%; max-width: 480px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 12px;
            overflow: hidden; display: flex; flex-direction: column;
        }
        
        /* --- é ‚éƒ¨ --- */
        .nav-bar {
            padding: 18px; text-align: center; font-size: 18px; font-weight: bold;
            border-bottom: 1px solid #eee; color: #333; letter-spacing: 1px;
            background: #fff;
            user-select: none;
        }
        
        .header-area { padding: 25px 25px 10px 25px; background: #fff; }
        .section-title { color: #555; font-size: 16px; font-weight: 600; margin: 0; }

        /* --- æ™‚é–“è»¸ --- */
        .timeline { position: relative; padding: 10px 0 40px 10px; background: #fff; }
        .timeline-item { position: relative; display: flex; align-items: flex-start; margin-bottom: 20px; }
        
        .line-bg { position: absolute; left: 19px; top: 10px; bottom: -30px; width: 2px; background: #e0e0e0; z-index: 0; }
        .line-active { position: absolute; left: 19px; top: 10px; width: 2px; height: calc(100% + 20px); background: #10b981; z-index: 0; display: none; }
        .line-active.show { display: block; }
        
        .icon {
            width: 20px; height: 20px; border-radius: 50%; background: #e0e0e0;
            border: 3px solid #fff; position: relative; z-index: 1; margin: 4px 15px 0 10px; flex-shrink: 0;
            transition: all 0.2s ease; cursor: pointer;
        }
        .icon:hover { transform: scale(1.1); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .icon.active { background: #10b981; }
        
        .content { flex: 1; margin-right: 25px; display: flex; flex-direction: column; }
        
        input.title-input {
            width: 100%; border: none; font-size: 16px; background: transparent; 
            color: #333; outline: none; padding: 2px 0; border-radius: 4px;
            transition: background 0.2s;
        }
        input.title-input:hover { background: #f8f8f8; }
        
        .is-main input.title-input { font-weight: 700; font-size: 17px; color: #222; }
        
        .is-sub { 
            padding-left: 15px; border-left: 3px solid #f0f0f0; 
            margin-top: -5px; margin-bottom: 5px;
        }
        .is-sub input.title-input { font-size: 15px; color: #555; }
        
        input.sub-note { 
            width: 100%; border: none; font-size: 12px; color: #999; 
            background: transparent; margin-top: 2px; outline: none;
        }

        /* --- æ—¥æœŸé¸æ“‡å€ (iPhone Chrome å„ªåŒ–ç‰ˆ) --- */
        .date-box {
            margin-top: 6px; text-align: right; position: relative;
            align-self: flex-end; 
            background: #f9f9f9; padding: 6px 12px; border-radius: 6px;
            transition: background 0.2s;
            display: flex; align-items: center; justify-content: flex-end;
            /* é—œéµ:é¿å…è§¸æ§äº‹ä»¶ç©¿é€å•é¡Œ */
            touch-action: manipulation;
        }
        .date-box:hover { background: #eee; }

        .date-text { 
            font-size: 13px; color: #bbb; display: inline-block; 
            min-width: 80px; text-align: center; 
            pointer-events: none; 
            position: relative; 
            z-index: 1;
        }
        .date-text.has-val { color: #333; font-weight: 500; }
        
        /* â˜…â˜…â˜… iPhone Chrome é–ƒçˆä¿®æ­£ç‰ˆ â˜…â˜…â˜… */
        .date-input {
            position: absolute; 
            left: 0; top: 0; 
            width: 100%; height: 100%;
            opacity: 0; 
            cursor: pointer; 
            margin: 0; padding: 0;
            z-index: 2;
            /* é˜²æ­¢ iOS ä¸Šçš„ç„¦é»å•é¡Œ */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Webkit æ—¥æ›†åœ–æ¨™å„ªåŒ– */
        .date-input::-webkit-calendar-picker-indicator {
            position: absolute;
            left: 0; top: 0;
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            cursor: pointer;
            opacity: 0;
        }

        /* --- åº•éƒ¨æŒ‰éˆ• --- */
        .controls { padding: 25px; background: #fafafa; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 15px; }
        button {
            padding: 14px; border-radius: 8px; font-size: 16px; border: none; font-weight: 600; width: 100%;
            cursor: pointer; transition: filter 0.2s;
        }
        .btn-green { background: #10b981; color: white; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-green:hover { filter: brightness(1.1); }
        .btn-green:active { filter: brightness(0.9); transform: translateY(1px); }
        
        .btn-outline { background: white; border: 1px solid #ddd; color: #666; }
        .btn-outline:hover { background: #f5f5f5; }

        #status-msg { font-size: 12px; text-align: center; color: #aaa; margin-bottom: 5px; height: 16px;}
    </style>
</head>
<body>

<div id="app">
    <div id="capture-area" style="background: white;">
        <div class="nav-bar">æˆ‘çš„æˆäº¤</div>
        <div class="header-area">
            <p class="section-title">å·¥ä½œé …ç›®</p>
        </div>
        <div id="list-container"></div>
    </div>

    <div class="controls">
        <div id="status-msg"></div>
        <button class="btn-green" onclick="doScreenshot(this)">ä¸‹è¼‰åœ–ç‰‡ (Save Image)</button>
        <button class="btn-outline" onclick="doReset()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<script>
(function() {
    var DATA_KEY = 'estate_v12_mobile_fix';
    
    var defaultStructure = [
        { t: 'ç°½ç´„', type: 'main' },
        { t: 'ç”¨å°', type: 'main' },
        { t: 'å ±ç¨…', type: 'main' },
        { t: 'ç”³å ±', type: 'sub', note: 'é è¨ˆ7æ—¥å¾Œæ ¸ç™¼' },
        { t: 'é ˜å–ç¨…å–®', type: 'sub', note: '' },
        { t: 'éŠ€è¡Œè²¸æ¬¾é‡‘é¡ç¢ºèª', type: 'main' },
        { t: 'å®Œç¨…', type: 'main' },
        { t: 'éæˆ¶', type: 'main' },
        { t: 'é€ä»¶', type: 'sub', note: 'ç”³å ±ç”¢æ¬Šç§»è½‰' },
        { t: 'é ˜ä»¶', type: 'sub', note: 'å®Œæˆç”¢æ¬Šç§»è½‰' },
        { t: 'ä»£å„Ÿè³£æ–¹è²¸æ¬¾', type: 'main' },
        { t: 'è³£æ–¹é ˜å¡—éŠ·æ–‡ä»¶', type: 'main' },
        { t: 'åœ°æ”¿å¡—éŠ·', type: 'main' },
        { t: 'è²·æ–¹éŠ€è¡ŒäºŒæ¬¡ä½œæ¥­', type: 'main' },
        { t: 'äº¤å±‹', type: 'main' }
    ];

    var items = [];

    function init() {
        try {
            var saved = localStorage.getItem(DATA_KEY);
            if (saved) {
                var parsed = JSON.parse(saved);
                if (parsed.length === defaultStructure.length) {
                    items = parsed;
                } else {
                    resetItems();
                }
            } else {
                resetItems();
            }
        } catch (e) {
            resetItems();
        }
        render();
        // â˜…â˜…â˜… é—œéµä¿®æ­£:å»¶é²ç¶å®šäº‹ä»¶è™•ç†å™¨,é¿å… iOS åˆå§‹åŒ–å•é¡Œ â˜…â˜…â˜…
        setTimeout(attachDateInputHandlers, 100);
    }

    function resetItems() {
        items = defaultStructure.map(function(def) {
            return {
                t: def.t,
                d: '',
                ok: false,
                s: def.note || '',
                type: def.type
            };
        });
    }

    function save() {
        try {
            localStorage.setItem(DATA_KEY, JSON.stringify(items));
            var msg = document.getElementById('status-msg');
            msg.innerText = "âœ“ è³‡æ–™å·²è‡ªå‹•å„²å­˜";
            setTimeout(function(){ msg.innerText = ""; }, 2000);
        } catch(e) {}
    }

    // â˜…â˜…â˜… æ–°å¢:iPhone Chrome é–ƒçˆå•é¡Œä¿®æ­£å‡½æ•¸ â˜…â˜…â˜…
    function attachDateInputHandlers() {
        var dateInputs = document.querySelectorAll('.date-input');
        
        for (var i = 0; i < dateInputs.length; i++) {
            (function(input) {
                // ä½¿ç”¨ touchstart è€Œé click,è§£æ±º iOS ç„¦é»å•é¡Œ
                input.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    // ç¢ºä¿ input ç²å¾—ç„¦é»
                    setTimeout(function() {
                        input.focus();
                    }, 10);
                }, { passive: true });

                // é˜²æ­¢ blur äº‹ä»¶å°è‡´é¸å–®é—œé–‰
                input.addEventListener('blur', function(e) {
                    // å¦‚æœæ­£åœ¨é¸æ“‡æ—¥æœŸ,å»¶é² blur è™•ç†
                    setTimeout(function() {
                        if (document.activeElement !== input) {
                            // blur è™•ç†é‚è¼¯(å¦‚æœéœ€è¦)
                        }
                    }, 100);
                });
            })(dateInputs[i]);
        }
    }

    window.render = function() {
        var container = document.getElementById('list-container');
        var html = '<div class="timeline">';
        
        for (var i = 0; i < items.length; i++) {
            var item = items[i];
            var isLast = i === items.length - 1;
            
            var activeClass = item.ok ? 'active' : '';
            var dateClass = item.d ? 'has-val' : '';
            var dateText = item.d ? item.d.replace(/-/g, '/') : 'ğŸ“… é¸æ“‡æ—¥æœŸ';
            var indentClass = (item.type === 'sub') ? 'is-sub' : 'is-main';

            var lineHtml = '';
            if (!isLast) {
                lineHtml += '<div class="line-bg"></div>';
                if (item.ok && items[i+1].ok) {
                    lineHtml += '<div class="line-active show"></div>';
                }
            }

            html += 
            '<div class="timeline-item">' +
                lineHtml +
                '<div class="icon ' + activeClass + '" onclick="toggle(' + i + ')"></div>' +
                '<div class="content ' + indentClass + '">' +
                    '<input class="title-input" value="' + item.t + '" oninput="updateTitle(' + i + ', this.value)">' +
                    '<input class="sub-note" placeholder="å‚™è¨»..." value="' + (item.s || '') + '" oninput="updateSub(' + i + ', this.value)">' +
                    
                    '<div class="date-box">' +
                        '<span class="date-text ' + dateClass + '">' + dateText + '</span>' +
                        '<input type="date" class="date-input" value="' + item.d + '" onchange="updateDate(' + i + ', this.value)">' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
        
        // æ¯æ¬¡ render å¾Œé‡æ–°ç¶å®šäº‹ä»¶
        attachDateInputHandlers();
    };

    window.toggle = function(i) { items[i].ok = !items[i].ok; save(); render(); };
    window.updateTitle = function(i, val) { items[i].t = val; save(); };
    window.updateSub = function(i, val) { items[i].s = val; save(); };
    window.updateDate = function(i, val) { items[i].d = val; save(); render(); };

    window.doReset = function() {
        if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ—¥æœŸèˆ‡ç‹€æ…‹å—?')) {
            resetItems();
            try { localStorage.removeItem(DATA_KEY); } catch(e){}
            render();
        }
    };

    window.doScreenshot = function(btn) {
        var oldText = btn.innerText;
        btn.innerText = "ç”Ÿæˆä¸­...";
        var area = document.getElementById('capture-area');
        
        html2canvas(area, { 
            scale: 2, backgroundColor: "#ffffff", useCORS: true 
        }).then(function(canvas) {
            var a = document.createElement('a');
            var dateStr = new Date().toISOString().split('T')[0];
            a.download = 'æ¡ˆä»¶é€²åº¦_' + dateStr + '.png';
            a.href = canvas.toDataURL("image/png");
            a.click();
            btn.innerText = oldText;
        }).catch(function(e) {
            alert("æˆªåœ–å¤±æ•—,è«‹ç¢ºèªç€è¦½å™¨æ”¯æ´åº¦");
            btn.innerText = oldText;
        });
    };

    init();

})();
</script>
</body>
</html>

</body>
</html>
